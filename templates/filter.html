{% load static %}
{% load filter_tags %}
{% block content %}
<div class="form-group">
<select value="frequency" id="{{id}}-frequency-performance">
    <option value="frequency">Frequency</option>
    <option value="performance">Performance</option>
</select><br>
<select class="form-select form-select-sm" value="{{id}}-{{filter.type}}" id="{{id}}-filter-select" onchange="changeSelect(this.value, '{{id}}')">
    <option value="{{id}}-select-default" disabled>Select Filter</option>
    <option value="{{id}}-case_performance">Case Performance</option>
    <option value="{{id}}-between_filter">Between Filter</option>
    <option value="{{id}}-case_size">Case Size</option>
    <option value="{{id}}-timestamp_filter_contained">Timestamp (Contained)</option>
    <option value="{{id}}-timestamp_filter_intersecting">Timestamp (Intersecting)</option>
    <option value="{{id}}-filter_on_attributes">Filter on attributes</option>
</select>
<div id="{{id}}-between-select" style="display: none;">
<select id="{{id}}-between-select1">
    {% for activity in log.get_activities %}
    <option value="{{activity}}">{{activity}}</option>
    {% endfor %}
</select>
<select id="{{id}}-between-select2">
    {% for activity in log.get_activities %}
    <option value="{{activity}}">{{activity}}</option>
    {% endfor %}
</select>
</div>
<div id="{{id}}-case-size" style="display: none;">
    <input type="number" id="{{id}}-case-size1">
    <input type="number" id="{{id}}-case-size2">
</div>
<div id="{{id}}-case-performance" style="display: none;">
    <input type="number" id="{{id}}-case-performance1">
    <input type="number" id="{{id}}-case-performance2">
</div>
<div id="{{id}}-timestamp" style="display: none;">
<select id="{{id}}-timestamp-select1">
    {% for timestamp in log.get_timestamps %}
    <option value="{{timestamp|convert_timestamp}}">{{timestamp|convert_timestamp}}</option>
    {% endfor %}
</select>
<select id="{{id}}-timestamp-select2">
    {% for timestamp in log.get_timestamps %}
    <option value="{{timestamp|convert_timestamp}}">{{timestamp|convert_timestamp}}</option>
    {% endfor %}
</select>
</div>
<div id="{{id}}-attribute-filter" style="display: none;">
<select id="{{id}}-attribute-select" onchange="changeAttributeVisualization(this.value,'{{id}}')">
    {% for attribute in log.get_properties %}
    <option value="{{attribute}}">{{attribute}}</option>
    {% endfor %}
</select>
{% for attribute, value_list in log.get_properties.items %}
    {% if value_list %}
    <div id="{{id}}-attribute-filter-{{attribute}}" style="display: none;">
        {% if attribute == "time:timestamp" %}  
        <select id="{{id}}-attribute-filter-{{attribute}}-select1">
            {% for value in value_list %}
            <option value="{{value|convert_timestamp}}">{{value|convert_timestamp}}</option>
            {% endfor %}
        </select>
        {% else %}
        <select id="{{id}}-attribute-filter-{{attribute}}-select1">
        {% for value in value_list %}
        <option value="{{value}}">{{value}}</option>
        {% endfor %}
        </select>
        {% endif %}
        <select id="{{id}}-attribute-filter-{{attribute}}-select2">
            {% for operation in value_list|get_operations %}
            <option value="{{operation}}">{{operation}}</option>          
            {% endfor %}
        </select>
</div>
    {% endif %}
{% endfor %}
</div>
<button id="{{id}}-sender"class ="btn btn-success">Apply Filter</button>
{% if filter %}
<button id="{{id}}-sender-delete" class="btn btn-danger">Reset filter</button>
{% endif %}

<script type="text/javascript">
function changeAttributeVisualization(attribute, id) {
    var attr_divs = []
    var attributes = {{ log|get_attributes | safe }}
    attributes.forEach(x => attr_divs.push(["-attribute-filter-",x].join("")))
    changeVisualization([id+"-attribute-filter-"+attribute], id, attr_divs)
}
// get all divs which should be toggled
divs = [
    "-between-select",
    "-case-size",
    "-case-performance",
    "-timestamp",
    "-attribute-filter"
]

// maps a choice to the divs that need to be visible in order to
// select the required attributes for the filter
function mapChoices(choice, id) {
    switch(choice) {
        case id+"-case_performance":
            return [id+"-case-performance"]
            break;
        
        case id+"-between_filter":
            return [id+"-between-select"]
            break;

        case id+"-case_size":
            return [id+"-case-size"]
            break;

        case id+"-timestamp_filter_contained":
        case id+"-timestamp_filter_intersecting":
            return [id+"-timestamp"]
            break;
        
        case id+"-filter_on_attributes":
            return [id+"-attribute-filter"]
            break;
    }
}

// arr: array of div ids
// sets all divs in arr to visible and those not in arr to not visible 
function changeVisualization(arr, id, div_arr=null) {
    if(!div_arr) {
        arr.forEach(el => document.getElementById(el).style.display = "block")
        divs.forEach(el => {
        if(arr.includes(id+el)) {
            return;
        }
        document.getElementById(id+el).style.display = "none"
    })
    } else {
        arr.forEach(el => document.getElementById(el).style.display = "block")
    div_arr.forEach(el => {
        if(arr.includes(id+el)) {
            return;
        }
        document.getElementById(id+el).style.display = "none"
    })
    }
    
}

// changes the display of input divs for a givens selection
function changeSelect(val, id) {
    changeVisualization(mapChoices(val, id),id);
}

document.addEventListener("DOMContentLoaded", function() {
    // if a filter is already existent, set default values
    id = "{{id}}"
    if("{{filter}}" != "None" && "{{filter.type}}" != "None") {
        type = "{{filter.type}}"
        choices = mapChoices(id+ '-'+type, id)
        if(choices.includes(id+"-between-select")) {
            document.getElementById(id+'-between-select1').value = "{{filter.case1}}"
            document.getElementById(id+'-between-select2').value = "{{filter.case2}}"
        }
        if(choices.includes(id+"-case-size")) {
            document.getElementById(id+'-case-size1').value ="{{filter.case_size1}}"
            document.getElementById(id+'-case-size2').value = "{{filter.case_size2}}"
            
        }
        if(choices.includes(id+"-case-performance")) {
            document.getElementById(id+'-case-performance1').value = "{{filter.case_performance1}}"
            document.getElementById(id+'-case-performance2').value = "{{filter.case_performance2}}"
        }
        if(choices.includes(id+"-timestamp")) {
            document.getElementById(id+'-timestamp-select1').value ="{{filter.timestamp1|convert_timestamp}}"
            document.getElementById(id+'-timestamp-select2').value ="{{filter.timestamp2|convert_timestamp}}"
        }
        if(choices.includes(id+"-attribute-filter")) {
            document.getElementById(id+"-attribute-select").value = "{{filter.attribute}}"
            document.getElementById(id+"-attribute-filter-"+"{{filter.attribute}}"+ "-select1").value = "{{filter.attribute_value}}"
            document.getElementById(id+"-attribute-filter-"+"{{filter.attribute}}"+ "-select2").value = "{{filter.operator}}"
            changeAttributeVisualization("{{filter.attribute}}", id)
        }
        document.getElementById(id+"-filter-select").value = id+ '-'+ type
        changeVisualization(choices, id)
        document.getElementById(id+"-frequency-performance").value = "{{filter.is_frequency}}" === "True" ? "frequency" : "performance"
    }   
    else {
        // set default view
        document.getElementById(id+"-filter-select").value = id + "-select-default"
        if("{{filter}}" != "None" ){
            document.getElementById(id+"-frequency-performance").value = "{{filter.is_frequency}}" === "True" ? "frequency" : "performance"
        } else {
            document.getElementById(id+"-frequency-performance").value = "frequency"
        }
    }
    
})

// sends a request to FilterView in order to set the filter
// values are taken from the respected fields the user omits from
$("#{{id}}-sender").click(function() {
    selected_filter = document.getElementById("{{id}}-filter-select").value
    switch(selected_filter) {
        case '{{id}}-case_performance':
            data = {
                type: selected_filter,
                is_frequency: document.getElementById("{{id}}-frequency-performance").value == "frequency",
                case_performance1: document.getElementById('{{id}}-case-performance1').value,
                case_performance2: document.getElementById('{{id}}-case-performance2').value
            }
            break;
        case '{{id}}-between_filter':
            data = {
                type: selected_filter,
                is_frequency: document.getElementById("{{id}}-frequency-performance").value == "frequency",
                case1: document.getElementById('{{id}}-between-select1').value,
                case2: document.getElementById('{{id}}-between-select2').value
            }
            break;
        case '{{id}}-case_size':
            data = {
                type: selected_filter,
                is_frequency: document.getElementById("{{id}}-frequency-performance").value == "frequency",
                case_size1: document.getElementById('{{id}}-case-size1').value,
                case_size2: document.getElementById('{{id}}-case-size2').value
            }
            break;
        case '{{id}}-timestamp_filter_contained':
        case '{{id}}-timestamp_filter_intersecting':
            data = {
                type: selected_filter,
                is_frequency: document.getElementById("{{id}}-frequency-performance").value == "frequency",
                timestamp1: document.getElementById('{{id}}-timestamp-select1').value,
                timestamp2: document.getElementById('{{id}}-timestamp-select2').value
            }
            break;
        case '{{id}}-filter_on_attributes':
            attribute = document.getElementById('{{id}}-attribute-select').value
            data = {
                type: selected_filter,
                is_frequency: document.getElementById("{{id}}-frequency-performance").value == "frequency",
                attribute: attribute,
                attribute_value: document.getElementById("{{id}}-attribute-filter-"+attribute+ "-select1").value,
                operator: document.getElementById("{{id}}-attribute-filter-"+attribute+ "-select2").value
            }
            break;            
        default:
            data = {
                id: "{{id}}",
                is_frequency: document.getElementById("{{id}}-frequency-performance").value == "frequency"
                }
            break;
    }
    $.ajax( {
        url: "{% url 'update_filter' %}",
        data: {
            data: JSON.stringify(data)
        },
        dataType: 'json',
        success: function() {
            location.reload(true)
        }
    })
})

// sends a request to FilterView in order to reset the filter associated to the log
$("#{{id}}-sender-delete").click(function() {
    $.ajax( {
        url: "{% url 'update_filter' %}",
        data: {
            data: JSON.stringify({
                delete: "{{id}}"
            })
        },
        dataType: 'json',
        success: function() {
            location.reload(true)
        }
    })
})
</script>

{% endblock %}
