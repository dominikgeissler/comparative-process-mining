{% load static %}
{% load filter_tags %}
{% block content %}
<select value="{{id}}-{{filter.type}}" id="{{id}}-filter-select" onchange="changeSelect(this.value, '{{id}}')">
    <option value="{{id}}-variant_percentage">Variant Percentage</option>
    <option value="{{id}}-variant_coverage_percentage">Variant Coverage Percentage</option>
    <option value="{{id}}-attribute_filter">Attribute Filter</option>
    <option value="{{id}}-case_performance">Case Performance</option>
    <option value="{{id}}-between_filter">Between Filter</option>
    <option value="{{id}}-case_size">Case Size</option>
    <option value="{{id}}-timestamp_filter_contained">Timestamp (Contained)</option>
    <option value="{{id}}-timestamp_filter_intersecting">Timestamp (Intersecting)</option>
</select>
<div id="{{id}}-percentage-range" style="display: none;"> 
    <label for="{{id}}-percentage-range-input" id="{{id}}-percentage-range-label" class="form-label">100</label><br>
    <input min="0" max="100" value="100" type="range" id="{{id}}-percentage-range-input" onchange="updateSlider(this.value, '{{id}}')">
</div>
<div id="{{id}}-attribute-select" style="display: none;">
    <select id="{{id}}-attribute-select1">
        {% for attribute in log.get_properties %}
        <option value="{{attribute}}">{{attribute}}</option>
        {% endfor %}
    </select>
</div>
<div id="{{id}}-between-select" style="display: none;">
<select id="{{id}}-between-select1">
    {% for activity in log.get_activities %}
    <option value="{{activity}}">{{activity}}</option>
    {% endfor %}
</select>
<select id="{{id}}-between-select2">
    {% for activity in log.get_activities %}
    <option value="{{activity}}">{{activity}}</option>
    {% endfor %}
</select>
</div>
<div id="{{id}}-case-size" style="display: none;">
    <input type="number" id="{{id}}-case-size1">
    <input type="number" id="{{id}}-case-size2">
</div>
<div id="{{id}}-case-performance" style="display: none;">
    <input type="number" id="{{id}}-case-performance1">
    <input type="number" id="{{id}}-case-performance2">
</div>
<div id="{{id}}-timestamp" style="display: none;">
<select id="{{id}}-timestamp-select1">
    {% for timestamp in log.get_timestamps %}
    <option value="{{timestamp}}">{{timestamp}}</option>
    {% endfor %}
</select>
<select id="{{id}}-timestamp-select2">
    {% for timestamp in log.get_timestamps %}
    <option value="{{timestamp}}">{{timestamp}}</option>
    {% endfor %}
</select>
</div>
<button id="{{id}}-sender">Click me</button>
{% if filter %}
<button id="{{id}}-sender-delete">Reset filter</button>
{% endif %}

<script type="text/javascript">
// get all divs which should be toggled
divs = [
    "-percentage-range",
    "-attribute-select",
    "-between-select",
    "-case-size",
    "-case-performance",
    "-timestamp"
]

// maps a choice to the divs that need to be visible in order to
// select the required attributes for the filter
function mapChoices(choice, id) {
    switch(choice) {
        case id+"-variant_percentage":
        case id+"-variant_coverage_percentage":
            return [id+"-percentage-range"]
            break;
        
        case id+"-attribute_filter":
            return [id+"-percentage-range",id+"-attribute-select"]
            break;
        
        case id+"-case_performance":
            return [id+"-case-performance"]
            break;
        
        case id+"-between_filter":
            return [id+"-between-select"]
            break;

        case id+"-case_size":
            return [id+"-case-size"]
            break;

        case id+"-timestamp_filter_contained":
        case id+"-timestamp_filter_intersecting":
            return [id+"-timestamp"]
            break;
    }
}

// arr: array of ids
// sets all divs in arr to visible and those not in arr to not visible 
function changeVisualization(arr, id) {
    arr.forEach(el => document.getElementById(el).style.display = "block")
    divs.forEach(el => {
        if(arr.includes(id+el)) {
            return;
        }
        document.getElementById(id+el).style.display = "none"
    })
}

// changes the display of input divs for a givens selection
function changeSelect(val, id) {
    changeVisualization(mapChoices(val, id),id);
}

document.addEventListener("DOMContentLoaded", function() {
    // if a filter is already existent, set default values
    id = "{{id}}"
    if("{{filter}}" != "None") {
        type = "{{filter.type}}"
        choices = mapChoices(id+ '-'+type, id)
        if (choices.includes(id+"-percentage-range")) {
            document.getElementById(id+"-percentage-range-input").value = "{{filter.percentage}}"
        }
        if(choices.includes(id+"-attribute-select")) {
            document.getElementById(id+"-attribute-select1").value = "{{filter.attribute}}"
        }
        if(choices.includes(id+"-between-select")) {
            document.getElementById(id+'-between-select1').value = "{{filter.case1}}"
            document.getElementById(id+'-between-select2').value = "{{filter.case2}}"
        }
        if(choices.includes(id+"-case-size")) {
            document.getElementById(id+'-case-size1').value ="{{filter.case_size1}}"
            document.getElementById(id+'-case-size2').value = "{{filter.case_size2}}"
            
        }
        if(choices.includes(id+"-case-performance")) {
            document.getElementById(id+'-case-performance1').value = "{{filter.case_performance1}}"
            document.getElementById(id+'-case-performance2').value = "{{filter.case_performance2}}"
        }
        if(choices.includes(id+"-timestamp")) {
            document.getElementById(id+'-timestamp-select1').value ="{{filter.timestamp1}}"
            document.getElementById(id+'-timestamp-select2').value ="{{filter.timestamp2}}"
        }
        document.getElementById(id+"-filter-select").value = id+ '-'+ type
        changeVisualization(choices, id)
    }   
    else {
        // set default view
        document.getElementById(id+"-filter-select").value = id + "-variant_percentage"
        changeVisualization([id+"-percentage-range"], id)
    }
})

// val: new value of slider
// id: the id
// updates the label next to the slider
function updateSlider(val, id) {
    document.getElementById(id+"-percentage-range-label").innerHTML = val
}

// sends a request to FilterView in order to set the filter
// values are taken from the respected fields the user omits from
$("#{{id}}-sender").click(function() {
    selected_filter = document.getElementById("{{id}}-filter-select").value
    switch(selected_filter) {
        case '{{id}}-variant_coverage_percentage':
        case '{{id}}-variant_percentage':
            data = {
                type: selected_filter,
                percentage: document.getElementById("{{id}}-percentage-range-input").value
            }
            break;
        case '{{id}}-attribute_filter':
            data = {
                    type: selected_filter,
                    percentage: document.getElementById("{{id}}-percentage-range-input").value,
                    attribute: document.getElementById("{{id}}-attribute-select1").value
            }
            break;
        case '{{id}}-case_performance':
            data = {
                type: selected_filter,
                case_performance1: document.getElementById('{{id}}-case-performance1').value,
                case_performance2: document.getElementById('{{id}}-case-performance2').value
            }
            break;
        case '{{id}}-between_filter':
            data = {
                type: selected_filter,
                case1: document.getElementById('{{id}}-between-select1').value,
                case2: document.getElementById('{{id}}-between-select2').value
            }
            break;
        case '{{id}}-case_size':
            data = {
                type: selected_filter,
                case_size1: document.getElementById('{{id}}-case-size1').value,
                case_size2: document.getElementById('{{id}}-case-size2').value
            }
            break;
        case '{{id}}-timestamp_filter_contained':
        case '{{id}}-timestamp_filter_intersecting':
            data = {
                type: selected_filter,
                timestamp1: document.getElementById('{{id}}-timestamp-select1').value,
                timestamp2: document.getElementById('{{id}}-timestamp-select2').value
            }
            break;
        default:
            return;
    }
    $.ajax( {
        url: "{% url 'update_filter' %}",
        data: {
            data: JSON.stringify(data)
        },
        dataType: 'json',
        success: function() {
            //location.reload(true)
        }
    })
})

// sends a request to FilterView in order to reset the filter associated to the log
$("#{{id}}-sender-delete").click(function() {
    $.ajax( {
        url: "{% url 'update_filter' %}",
        data: {
            data: JSON.stringify({
                delete: "{{id}}"
            })
        },
        dataType: 'json',
        success: function() {
            location.reload(true)
        }
    })
})
</script>

{% endblock %}