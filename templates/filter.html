{% load static %}
{% load filter_tags %}
{% block content %}
<select value="{{id}}-{{filter.type}}" id="filter-select-{{id}}" onchange="changeSelect(this.value)">
    <option value="{{id}}-variant_percentage">Variant Percentage</option>
    <option value="{{id}}-variant_coverage_percentage">Variant Coverage Percentage</option>
    <option value="{{id}}-attribute_filter">Attribute Filter</option>
    <option value="{{id}}-case_performance">Case Performance</option>
    <option value="{{id}}-between_filter">Between Filter</option>
    <option value="{{id}}-case_size">Case Size</option>
</select>
<div class="hideable" id="{{id}}-percentage-range"> 
    <label for="range-{{id}}" id="label-range-{{id}}" class="form-label">100</label><br>
    <input min="0" max="100" value="100" type="range" id="range-{{id}}" onchange="updateSlider(this.value, '{{id}}')">
</div>
<div class="hideable" id="{{id}}-attribute-select">
    <select id="{{id}}-attribute-select1">
        {% for attribute in log.get_properties %}
        <option value="{{attribute}}">{{attribute}}</option>
        {% endfor %}
    </select>
</div>
<div class="hideable" id="{{id}}-between-select">
<select id="{{id}}-between-select1">
    {% for activity in log.get_activities %}
    <option value="{{activity}}">{{activity}}</option>
    {% endfor %}
</select>
<select id="{{id}}-between-select2">
    {% for activity in log.get_activities %}
    <option value="{{activity}}">{{activity}}</option>
    {% endfor %}
</select>
</div>
<div class="hideable" id="{{id}}-case-size">
    <input type="number" id="{{id}}-case-size1">
    <input type="number" id="{{id}}-case-size2">
</div>
<div class="hideable" id="{{id}}-case-performance">
    <input type="number" id="{{id}}-case-performance1">
    <input type="number" id="{{id}}-case-performance2">
</div>
<button id="{{id}}-sender">Click me</button>
{% if filter %}
<button id="{{id}}-sender-delete">Reset filter</button>
{% endif %}

<script type="text/javascript">
// get all divs which should be toggled
divs = document.getElementsByClassName("hideable")

// set id
id = "{{id}}"

// gets the divs ids 
div_ids = []
for(let i = 0; i<divs.length; i++) {
    div_ids.push(divs[i].id)
}

// array of all supported filters in select
choices = [
    id+"-variant_percentage",
    id+"-variant_coverage_percentage",
    id+"-attribute_filter",
    id+"-case_performance",
    id+"-between_filter",
    id+"-case_size",
]


// maps a choice to the divs that need to be visible in order to
// select the required attributes for the filter
function mapChoices(choice) {
    switch(choice) {
        default:
        case id+"-variant_percentage":
        case id+"-variant_coverage_percentage":
            return [id+"-percentage-range"]
            break;
        
        case id+"-attribute_filter":
            return [id+"-percentage-range",id+"-attribute-select"]
            break;
        
        case id+"-case_performance":
            return [id+"-case-performance"]
            break;
        
        case id+"-between_filter":
            return [id+"-between-select"]
            break;

        case id+"-case_size":
            return [id+"-case-size"]
            break;
    }
}

// arr: array of ids
// sets all divs in arr to visible and those not in arr to not visible 
function changeVisualization(arr) {
    arr.forEach(el => divs[div_ids.findIndex(id => id == el)].style.display = "block")
    div_ids.forEach((el,index) => {
        if(arr.includes(el)) {
            return;
        }
        divs[index].style.display = "none"
    })
}

function changeSelect(val) {
    changeVisualization(mapChoices(val));
}

document.addEventListener("DOMContentLoaded", function() {

})

// val: new value of slider
// id: the id
// updates the label next to the slider
function updateSlider(val, id) {
    document.getElementById("label-range-"+id).innerHTML = val
}

// sends a request to FilterView in order to set the filter
// values are taken from the respected fields the user omits from
$("#{{id}}-sender").click(function() {
    selected_filter = document.getElementById("filter-select-{{id}}").value
    switch(selected_filter) {
        case '{{id}}-variant_coverage_percentage':
        case '{{id}}-variant_percentage':
            data = {
                type: selected_filter,
                percentage: document.getElementById("range-{{id}}").value
            }
            break;
        case '{{id}}-attribute_filter':
            data = {
                    type: selected_filter,
                    percentage: document.getElementById("range-{{id}}").value,
                    attribute: document.getElementById("{{id}}-attribute-select1").value
            }
            break;
        case '{{id}}-case_performance':
            data = {
                type: selected_filter,
                case_performance1: document.getElementById('{{id}}-case-performance1').value,
                case_performance2: document.getElementById('{{id}}-case-performance2').value
            }
            break;
        case '{{id}}-between_filter':
            data = {
                type: selected_filter,
                case1: document.getElementById('{{id}}-between-select1').value,
                case2: document.getElementById('{{id}}-between-select2').value
            }
            break;
        case '{{id}}-case_size':
            data = {
                type: selected_filter,
                case_size1: document.getElementById('{{id}}-case-size1').value,
                case_size2: document.getElementById('{{id}}-case-size2').value
            }
            break;
        default:
            return;
    }
    $.ajax( {
        url: "{% url 'update_filter' %}",
        data: {
            data: JSON.stringify(data)
        },
        dataType: 'json',
        success: function() {
            location.reload(true)
        }
    })
})

// sends a request to FilterView in order to reset the filter associated to the log
$("#{{id}}-sender-delete").click(function() {
    $.ajax( {
        url: "{% url 'update_filter' %}",
        data: {
            data: JSON.stringify({
                delete: "{{id}}"
            })
        },
        dataType: 'json',
        success: function() {
            location.reload(true)
        }
    })
})
</script>

{% endblock %}